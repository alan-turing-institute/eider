<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="eider">
<title>Date Merging • eider</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Fira_Sans-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Fira_Mono-0.4.9/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Date Merging">
<meta property="og:description" content="eider">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">eider</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/eider.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/a_and_e.html">A &amp; E Example</a>
    <a class="dropdown-item" href="../articles/combine.html">Combine Example</a>
    <a class="dropdown-item" href="../articles/date_merging.html">Date Merging</a>
    <a class="dropdown-item" href="../articles/logging.html">Logging Example</a>
    <a class="dropdown-item" href="../articles/prescribing.html">Prescribing Example</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="date_merging_files/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="date_merging_files/kePrint-0.0.1/kePrint.js"></script><link href="date_merging_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Date Merging</h1>
            
      
      
      <div class="d-none name"><code>date_merging.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">eider</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'eider'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     transform</span></span></code></pre></div>
<p>Formatting</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/" class="external-link">knitr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/" class="external-link">kableExtra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Attaching core tidyverse packages</span> ──────────────────────── tidyverse 2.0.0 ──</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dplyr    </span> 1.1.4     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">readr    </span> 2.1.5</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">forcats  </span> 1.0.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">stringr  </span> 1.5.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">ggplot2  </span> 3.5.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tibble   </span> 3.2.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">lubridate</span> 1.9.3     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tidyr    </span> 1.3.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">purrr    </span> 1.0.2     </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Conflicts</span> ────────────────────────────────────────── tidyverse_conflicts() ──</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">filter()</span>     masks <span style="color: #0000BB;">stats</span>::filter()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">group_rows()</span> masks <span style="color: #0000BB;">kableExtra</span>::group_rows()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">lag()</span>        masks <span style="color: #0000BB;">stats</span>::lag()</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use the conflicted package (<span style="color: #0000BB; font-style: italic;">&lt;http://conflicted.r-lib.org/&gt;</span>) to force all conflicts to become errors</span></span>
<span><span class="va">kbl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>format <span class="op">=</span> <span class="st">"html"</span>,</span>
<span>                 table.attr <span class="op">=</span> <span class="st">'data-quarto-disable-processing="true"'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">kableExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html" class="external-link">kable_styling</a></span><span class="op">(</span>bootstrap_options <span class="op">=</span> <span class="st">"striped"</span>,</span>
<span>                              full_width <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level2">
<h2 id="read-in-data">1. Read in data<a class="anchor" aria-label="anchor" href="#read-in-data"></a>
</h2>
<p>Here we are reading in data about patients stays where they can have multiple episodes in one stay</p>
<p>This is the original dataframe</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">smr04_data_filepath</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eider_example.html">eider_example</a></span><span class="op">(</span><span class="st">"random_smr04_data.csv"</span><span class="op">)</span></span>
<span><span class="va">initial_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_data.html">read_data</a></span><span class="op">(</span><span class="va">smr04_data_filepath</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">initial_table</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kbl.html" class="external-link">kbl</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table data-quarto-disable-processing="true" class="table table table-striped" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:right;">
id
</th>
<th style="text-align:left;">
admission_date
</th>
<th style="text-align:left;">
discharge_date
</th>
<th style="text-align:right;">
cis_marker
</th>
<th style="text-align:right;">
episode_within_cis
</th>
<th style="text-align:left;">
some_code
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
15
</td>
<td style="text-align:left;">
2016-11-18
</td>
<td style="text-align:left;">
2016-11-19
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
b
</td>
</tr>
<tr>
<td style="text-align:right;">
14
</td>
<td style="text-align:left;">
2015-07-31
</td>
<td style="text-align:left;">
2015-07-31
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
b
</td>
</tr>
<tr>
<td style="text-align:right;">
14
</td>
<td style="text-align:left;">
2015-07-31
</td>
<td style="text-align:left;">
2015-08-01
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
d
</td>
</tr>
<tr>
<td style="text-align:right;">
19
</td>
<td style="text-align:left;">
2017-05-22
</td>
<td style="text-align:left;">
2017-05-24
</td>
<td style="text-align:right;">
52
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
c
</td>
</tr>
<tr>
<td style="text-align:right;">
11
</td>
<td style="text-align:left;">
2016-08-19
</td>
<td style="text-align:left;">
2016-08-21
</td>
<td style="text-align:right;">
28
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
d
</td>
</tr>
<tr>
<td style="text-align:right;">
14
</td>
<td style="text-align:left;">
2015-02-15
</td>
<td style="text-align:left;">
2015-02-16
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
a
</td>
</tr>
<tr>
<td style="text-align:right;">
7
</td>
<td style="text-align:left;">
2016-10-19
</td>
<td style="text-align:left;">
2016-10-20
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
e
</td>
</tr>
<tr>
<td style="text-align:right;">
7
</td>
<td style="text-align:left;">
2016-10-20
</td>
<td style="text-align:left;">
2016-10-20
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
d
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
2016-08-06
</td>
<td style="text-align:left;">
2016-08-07
</td>
<td style="text-align:right;">
79
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
b
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
2016-08-07
</td>
<td style="text-align:left;">
2016-08-10
</td>
<td style="text-align:right;">
79
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
d
</td>
</tr>
</tbody>
</table>
<p>Each row is an episode. Multiple episodes make up a stay. The <code>cis_marker</code> field can be used to group episodes from one id into a stay. I.e. all rows for a (<code>id</code>, <code>cis_marker</code>) tuple correspond to a single stay. <code>episode_within_cis</code> tells us the order of the episodes within a stay.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p3_only</span> <span class="op">&lt;-</span> <span class="va">initial_table</span><span class="op">[</span><span class="va">initial_table</span><span class="op">$</span><span class="va">id</span> <span class="op">==</span> <span class="fl">3</span>, <span class="op">]</span></span>
<span><span class="va">p3_only</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kbl.html" class="external-link">kbl</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table data-quarto-disable-processing="true" class="table table table-striped" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:right;">
id
</th>
<th style="text-align:left;">
admission_date
</th>
<th style="text-align:left;">
discharge_date
</th>
<th style="text-align:right;">
cis_marker
</th>
<th style="text-align:right;">
episode_within_cis
</th>
<th style="text-align:left;">
some_code
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2015-05-17
</td>
<td style="text-align:left;">
2015-05-17
</td>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
d
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2015-05-17
</td>
<td style="text-align:left;">
2015-05-17
</td>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
c
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2015-05-17
</td>
<td style="text-align:left;">
2015-05-17
</td>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
b
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2017-01-25
</td>
<td style="text-align:left;">
2017-01-29
</td>
<td style="text-align:right;">
24
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
b
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2017-02-01
</td>
<td style="text-align:left;">
2017-02-01
</td>
<td style="text-align:right;">
25
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
a
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2015-04-21
</td>
<td style="text-align:left;">
2015-04-22
</td>
<td style="text-align:right;">
26
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
c
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2015-04-22
</td>
<td style="text-align:left;">
2015-04-22
</td>
<td style="text-align:right;">
26
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
e
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2015-04-22
</td>
<td style="text-align:left;">
2015-04-24
</td>
<td style="text-align:right;">
26
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
b
</td>
</tr>
</tbody>
</table>
<p>Using patient with ID of 3 as an example - the data contains details of 4 episodes (with <code>CIS_MARKERS</code> of 23, 24, 25, and 26). For the stay with <code>CIS_MARKER</code> 23, there were three episodes, all started on 17th May 2015 and ended on the same date. For the stays with <code>CIS_MARKER</code> 24, and 25, there was only one episode, and for the stay with <code>CIS_MARKER</code> 26 there were 3 episodes, the first episode had an admission date of 21st April 2015, and a discharge date of the 22nd April. The second episode had an admission date of the 22nd April and a discharge date of the same day, and the third episode had an admission date of the 22nd but a discharge date of the 24th. This stay for patient 3 spanned the 21st to 24th of April.</p>
<p>With episodic data is could be necessary to filter on dates. If in the example of patient with ID 14 the cut-off-date was set as 1st August, then the first episode in their stay would be omitted, and potentially the second episode would be assumed to be the first.</p>
</div>
<div class="section level2">
<h2 id="describe-the-pre-processing">2. Describe the pre-processing<a class="anchor" aria-label="anchor" href="#describe-the-pre-processing"></a>
</h2>
<p>The way <code>eider</code> has approached this, is to allow users to pre-process their data, to merge episodes into stays. In this case by specifying that they can select the earliest admission date for each stay and the latest discharge date for each stay and replace each episode with the stay-related span.</p>
<p>The key features outlined here are: The <code>grouping_column</code>, the <code>preprocess$on</code> as well as the <code>preprocess$retain_min</code> and <code>preprocess$retain_max</code>. We can put these in a mini specification and call the preprocessing function directly</p>
<p>Here we define a mini specification with only the important features</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">minispec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">minispec</span><span class="op">$</span><span class="va">grouping_column</span> <span class="op">&lt;-</span> <span class="st">"id"</span></span>
<span><span class="va">minispec</span><span class="op">$</span><span class="va">preprocess</span><span class="op">$</span><span class="va">on</span> <span class="op">&lt;-</span> <span class="st">"cis_marker"</span></span>
<span><span class="va">minispec</span><span class="op">$</span><span class="va">preprocess</span><span class="op">$</span><span class="va">retain_min</span> <span class="op">&lt;-</span> <span class="st">"admission_date"</span></span>
<span><span class="va">minispec</span><span class="op">$</span><span class="va">preprocess</span><span class="op">$</span><span class="va">retain_max</span> <span class="op">&lt;-</span> <span class="st">"discharge_date"</span></span></code></pre></div>
<p>This mini-specification will use the <code>cis_marker</code> column to identify which episodes belong with a given patient stay, and then the minimum <code>admission_date</code> and maximum <code>discharge_date</code> are replaced in the initial data Then we can run it with the example SMR04 data</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">processed_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/preprocess_table.html">preprocess_table</a></span><span class="op">(</span>input_table <span class="op">=</span> <span class="va">initial_table</span>,</span>
<span>                                    spec <span class="op">=</span> <span class="va">minispec</span><span class="op">)</span></span>
<span><span class="va">p3_processed</span> <span class="op">&lt;-</span> <span class="va">processed_table</span><span class="op">[</span><span class="va">processed_table</span><span class="op">$</span><span class="va">id</span> <span class="op">==</span> <span class="fl">3</span>, <span class="op">]</span></span>
<span><span class="va">p3_processed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kbl.html" class="external-link">kbl</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table data-quarto-disable-processing="true" class="table table table-striped" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:right;">
id
</th>
<th style="text-align:left;">
admission_date
</th>
<th style="text-align:left;">
discharge_date
</th>
<th style="text-align:right;">
cis_marker
</th>
<th style="text-align:right;">
episode_within_cis
</th>
<th style="text-align:left;">
some_code
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2015-05-17
</td>
<td style="text-align:left;">
2015-05-17
</td>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
d
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2015-05-17
</td>
<td style="text-align:left;">
2015-05-17
</td>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
c
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2015-05-17
</td>
<td style="text-align:left;">
2015-05-17
</td>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
b
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2017-01-25
</td>
<td style="text-align:left;">
2017-01-29
</td>
<td style="text-align:right;">
24
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
b
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2017-02-01
</td>
<td style="text-align:left;">
2017-02-01
</td>
<td style="text-align:right;">
25
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
a
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2015-04-21
</td>
<td style="text-align:left;">
2015-04-24
</td>
<td style="text-align:right;">
26
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
c
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2015-04-21
</td>
<td style="text-align:left;">
2015-04-24
</td>
<td style="text-align:right;">
26
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
e
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2015-04-21
</td>
<td style="text-align:left;">
2015-04-24
</td>
<td style="text-align:right;">
26
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
b
</td>
</tr>
</tbody>
</table>
<p>The pre-processing mutates the initial table and (based on the specification) takes the earliest admission date for each stay (comprising a single or multiple episodes) and the latest discharge date. So now patient 3 still has 4 stays in the data, but now all episodes within the stay with <code>CIS_MARKER</code> 26, has the same admission and discharge date. This allows filtering to account for a whole stay rather than an episode within a stay.</p>
</div>
<div class="section level2">
<h2 id="without-and-with-preprocessing">3. Without and With preprocessing<a class="anchor" aria-label="anchor" href="#without-and-with-preprocessing"></a>
</h2>
<p>Here are two full specification files, one without the preprocessing request, and one with.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec_without_preprocessing</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eider_example.html">eider_example</a></span><span class="op">(</span><span class="st">"spec_smr04.json"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">spec_without_preprocessing</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;   "source_file": ["smr04"],</span></span>
<span><span class="co">#&gt;   "transformation_type": ["COUNT"],</span></span>
<span><span class="co">#&gt;   "grouping_column": ["id"],</span></span>
<span><span class="co">#&gt;   "absent_default_value": 0,</span></span>
<span><span class="co">#&gt;   "output_feature_name": ["no_preprocessing"],</span></span>
<span><span class="co">#&gt;   "primary_filter": {</span></span>
<span><span class="co">#&gt;     "type": ["AND"],</span></span>
<span><span class="co">#&gt;     "subfilters": {</span></span>
<span><span class="co">#&gt;       "subfilter_1": {</span></span>
<span><span class="co">#&gt;         "column": ["episode_within_cis"],</span></span>
<span><span class="co">#&gt;         "type": ["IN"],</span></span>
<span><span class="co">#&gt;         "value": [1, 2, 3]</span></span>
<span><span class="co">#&gt;       },</span></span>
<span><span class="co">#&gt;     "subfilter_2": {</span></span>
<span><span class="co">#&gt;         "column": "discharge_date",</span></span>
<span><span class="co">#&gt;         "type": "date_lt_eq",</span></span>
<span><span class="co">#&gt;         "value": ["2015-04-22"]</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
<p>This spec is requesting a count of the number of times episode 1, 2, or 3 from <code>episode_within_cis</code> occurs for <code>DISCHARGE_DATE</code> earlier than (or equal to) 22nd April 2015.</p>
<p>For patient 3, without the preprocessing step we expect this to count 2 of the 8 episodes, the two with <code>CIS_MARKER</code> 26 and <code>DISCHARGE_DATE</code> of 22nd April 2015, the final episode in that stay does not satisfy the date condition and so is not expected to be counted.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec_with_preprocessing</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eider_example.html">eider_example</a></span><span class="op">(</span><span class="st">"spec_smr04_preprocessing.json"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">spec_with_preprocessing</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;   "source_file": ["smr04"],</span></span>
<span><span class="co">#&gt;   "transformation_type": ["COUNT"],</span></span>
<span><span class="co">#&gt;   "grouping_column": ["id"],</span></span>
<span><span class="co">#&gt;   "absent_default_value": 0,</span></span>
<span><span class="co">#&gt;   "output_feature_name": ["with_preprocessing"],</span></span>
<span><span class="co">#&gt;   "preprocess": {</span></span>
<span><span class="co">#&gt;     "on": "cis_marker",</span></span>
<span><span class="co">#&gt;     "retain_min": "admission_date",</span></span>
<span><span class="co">#&gt;     "retain_max": "discharge_date"</span></span>
<span><span class="co">#&gt;     },</span></span>
<span><span class="co">#&gt;   "primary_filter": {</span></span>
<span><span class="co">#&gt;     "type": ["AND"],</span></span>
<span><span class="co">#&gt;     "subfilters": {</span></span>
<span><span class="co">#&gt;       "subfilter_1": {</span></span>
<span><span class="co">#&gt;         "column": ["episode_within_cis"],</span></span>
<span><span class="co">#&gt;         "type": ["IN"],</span></span>
<span><span class="co">#&gt;         "value": [1, 2, 3]</span></span>
<span><span class="co">#&gt;       },</span></span>
<span><span class="co">#&gt;     "subfilter_2": {</span></span>
<span><span class="co">#&gt;         "column": "discharge_date",</span></span>
<span><span class="co">#&gt;         "type": "date_lt_eq",</span></span>
<span><span class="co">#&gt;         "value": ["2015-04-22"]</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
<p>This spec is requesting the same thing, but now has the preprocessing step included. The <code>DISCHARGE_DATE</code> for all episodes in the stay with <code>CIS_MARKER</code> 26 will now all be the same - the latest discharge date from the stay, and the transform will count none of the total episodes for patient 3. This means that there will now be zero episodes which match the criteria.</p>
<p>Read in the data table</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">smr04_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_data.html">read_data</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>smr04 <span class="op">=</span> <span class="fu"><a href="../reference/eider_example.html">eider_example</a></span><span class="op">(</span><span class="st">"random_smr04_data.csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This featurise call does not use the preprocessing flags</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w_out_preprocessing</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/featurise.html">featurise</a></span><span class="op">(</span></span>
<span>  <span class="va">smr04_table</span>,</span>
<span>  <span class="fu"><a href="../reference/json_to_feature.html">json_to_feature</a></span><span class="op">(</span><span class="va">spec_without_preprocessing</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This featurise call does use the preprocessing flags,</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w_preprocessing</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/featurise.html">featurise</a></span><span class="op">(</span></span>
<span>  <span class="va">smr04_table</span>,</span>
<span>  <span class="fu"><a href="../reference/json_to_feature.html">json_to_feature</a></span><span class="op">(</span><span class="va">spec_with_preprocessing</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Joining the resultant tables:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">joined_feature_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/join_feature_tables.html">join_feature_tables</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">w_out_preprocessing</span>,</span>
<span>                                                 <span class="va">w_preprocessing</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">joined_feature_table</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kbl.html" class="external-link">kbl</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table data-quarto-disable-processing="true" class="table table table-striped" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:right;">
id
</th>
<th style="text-align:right;">
no_preprocessing
</th>
<th style="text-align:right;">
with_preprocessing
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table>
<p>Comparing the above, we can see that for patient with id 3, when no pre-processing is applied, two episodes are counted, but when the preprocessing step is applied, zero are.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Camila Rangel Smith, Helen Duncan Little, Jonathan Yong.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
