<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>eider</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">eider</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#process-pipeline" id="toc-process-pipeline" class="nav-link active" data-scroll-target="#process-pipeline">Process pipeline</a>
  <ul class="collapse">
  <li><a href="#decide-what-you-want-to-filter-for" id="toc-decide-what-you-want-to-filter-for" class="nav-link" data-scroll-target="#decide-what-you-want-to-filter-for">0. Decide what you want to filter for</a></li>
  <li><a href="#read-in-data" id="toc-read-in-data" class="nav-link" data-scroll-target="#read-in-data">1. Read in data</a></li>
  <li><a href="#define-a-feature-to-extract" id="toc-define-a-feature-to-extract" class="nav-link" data-scroll-target="#define-a-feature-to-extract">2. Define a feature to extract</a></li>
  <li><a href="#extract-the-feature" id="toc-extract-the-feature" class="nav-link" data-scroll-target="#extract-the-feature">3. Extract the feature</a></li>
  <li><a href="#using-date-filtering" id="toc-using-date-filtering" class="nav-link" data-scroll-target="#using-date-filtering">4. Using date filtering</a></li>
  <li><a href="#using-or-filter" id="toc-using-or-filter" class="nav-link" data-scroll-target="#using-or-filter">5. Using OR filter</a></li>
  <li><a href="#logging" id="toc-logging" class="nav-link" data-scroll-target="#logging">6.Logging</a></li>
  <li><a href="#glossary" id="toc-glossary" class="nav-link" data-scroll-target="#glossary">Glossary</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">eider</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This Quarto book serves as a demo of the <code>eider</code> package. Focussing on the A&amp;E data</p>
<p>First, we load the package from the local directory.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"../eider/"</span>, <span class="at">repos =</span> <span class="cn">NULL</span>, <span class="at">type =</span> <span class="st">"source"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Installing package into '/home/runner/work/_temp/Library'
(as 'lib' is unspecified)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(eider)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'eider'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:base':

    transform</code></pre>
</div>
</div>
<p>Also, let’s set up a function to visualise tables nicely.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.0     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter()     masks stats::filter()
✖ dplyr::group_rows() masks kableExtra::group_rows()
✖ dplyr::lag()        masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>kbl <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">head</span>(x, <span class="dv">10</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">%&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">format =</span> <span class="st">'html'</span>, </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">table.attr =</span> <span class="st">'data-quarto-disable-processing="true"'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<section id="process-pipeline" class="level1">
<h1>Process pipeline</h1>
<section id="decide-what-you-want-to-filter-for" class="level2">
<h2 class="anchored" data-anchor-id="decide-what-you-want-to-filter-for">0. Decide what you want to filter for</h2>
<p><code>eider</code> is designed to process (Scottish) medical data and collate using a range of filter functions to allow users to easily extract tables for ML pipelines.</p>
<p>Argubly the first step should be to decide which data you will use, and how you will filter it. <code>eider</code> allows users to specify a range of data sources (files/tables) and to define which features they want to extract data via a specification json. <code>eider</code> will filter and join the data as per the spec.</p>
</section>
<section id="read-in-data" class="level2">
<h2 class="anchored" data-anchor-id="read-in-data">1. Read in data</h2>
<p>In this example we will use some random A&amp;E-type data stored in a csv file, and filter based on 2 categories. The <code>attendance_type</code> column and the <code>diagnosis_1</code> column. But data can be derived from multiple sources, and joined subsequently.</p>
<p>This step must be done before any feature extraction to avoid having to read the same table multiple times.</p>
<p>Here we are utilising MINISPARRA’s example data which is accessed via <code>eider_examples("random_ae_data.csv")</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ae_data_filepath <span class="ot">&lt;-</span> <span class="fu">eider_example</span>(<span class="st">"random_ae_data.csv"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">read.csv</span>(ae_data_filepath) <span class="sc">%&gt;%</span> <span class="fu">kbl</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-disable-processing="true" class="table table-striped" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> id </th>
   <th style="text-align:left;"> time </th>
   <th style="text-align:right;"> attendance_category </th>
   <th style="text-align:right;"> diagnosis_1 </th>
   <th style="text-align:right;"> diagnosis_2 </th>
   <th style="text-align:right;"> diagnosis_3 </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:left;"> 2016-08-16 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 104 </td>
   <td style="text-align:right;"> 103 </td>
   <td style="text-align:right;"> 102 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:left;"> 2015-07-28 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 101 </td>
   <td style="text-align:right;"> 103 </td>
   <td style="text-align:right;"> 104 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 16 </td>
   <td style="text-align:left;"> 2017-09-20 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 102 </td>
   <td style="text-align:right;"> 101 </td>
   <td style="text-align:right;"> 104 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 10 </td>
   <td style="text-align:left;"> 2016-03-25 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 104 </td>
   <td style="text-align:right;"> 103 </td>
   <td style="text-align:right;"> 101 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:left;"> 2016-09-20 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 103 </td>
   <td style="text-align:right;"> 104 </td>
   <td style="text-align:right;"> 101 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:left;"> 2016-02-11 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 103 </td>
   <td style="text-align:right;"> 102 </td>
   <td style="text-align:right;"> 101 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 14 </td>
   <td style="text-align:left;"> 2016-02-14 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 102 </td>
   <td style="text-align:right;"> 103 </td>
   <td style="text-align:right;"> 104 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 14 </td>
   <td style="text-align:left;"> 2015-11-09 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 104 </td>
   <td style="text-align:right;"> 103 </td>
   <td style="text-align:right;"> 102 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 14 </td>
   <td style="text-align:left;"> 2016-03-24 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 102 </td>
   <td style="text-align:right;"> 101 </td>
   <td style="text-align:right;"> 104 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:left;"> 2015-07-01 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 103 </td>
   <td style="text-align:right;"> 104 </td>
   <td style="text-align:right;"> 101 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>A snippet of the table is shown above.</p>
<p>The table has 6 columns, a patient id <code>id</code>, a <code>date</code> TODO update header at which the admission occured, an <code>attendance_type</code>, and three diagnosis categories, <code>diagnosis_1</code>, <code>diagnosis_2</code>, and <code>diagnosis_3</code></p>
<p>From the first row in this example we can see that patient 2 was admitted on the 16th of August 2016, they had 3 unique diagnoses, 104, 103, and 102. In the second row, the patient with the same id was admitted on the 28th July 2015, again they had 3 unique diagnosis, this time 101, 103, and 104.</p>
</section>
<section id="define-a-feature-to-extract" class="level2">
<h2 class="anchored" data-anchor-id="define-a-feature-to-extract">2. Define a feature to extract</h2>
<p>Users then specify which features they would like to extract from which data. A simple specification file is given below.</p>
<p><code>source_file</code> is the name for the corresponding filepath in a named list (in this case the random A&amp;E data). <code>transformation_type</code> is the type of transformation which will take place. eider has N different transformation types, X, Y, and Z. The user specifies how the data will be grouped via <code>grouping_columns</code>, which in this case is grouping by patient ID. An (optional) flag for what to do if data is absent is given - here it will be to report 0. <code>output_feature_name</code> defines the header for the column in the output dataframe which will contain the results of the specific transformation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>basic_ae_spec_filepath <span class="ot">&lt;-</span> <span class="fu">eider_example</span>(<span class="st">"spec_basic_ae_data.json"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(<span class="fu">readLines</span>(basic_ae_spec_filepath)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "source_file": ["ae2"],
  "transformation_type": ["COUNT"],
  "grouping_columns": ["id"],
  "absent_data_flag": [0],
  "output_feature_name": ["user_defined_name"],
  "primary_filter": {
    "type": ["AND"],
    "subfilters": {
      "subfilter_1": {
        "column": ["attendance_category"],
        "type": ["IN"],
        "value": [1]
      },
      "subfilter_2": {
        "column": ["diagnosis_1"],
        "type": ["IN"],
        "value": [101]
      }
    }
  }
}</code></pre>
</div>
</div>
<p>The <code>primary_filter</code> is AND, and there are two <code>subfilters</code>. The first subfilter - <code>subfilter_1</code> specifies that the user wants to filter based on the <code>attendance_category</code> column of the random A&amp;E-type data, and that the value that they are interested in is 1. That is only return results where the <code>attendance_category</code> is 1.</p>
<p>The second subfilter <code>subfilter_2</code> filters based on the <code>diagnosis_1</code> column and should only return results where <code>diagnosis_1</code> is 101.</p>
<p>As the primary filter is AND, the resultant dataframe will be a count, grouped by patient <code>id</code> of A&amp;E data with <code>attendance_category</code> = 1 AND <code>diagnosos_1</code> = 101.</p>
</section>
<section id="extract-the-feature" class="level2">
<h2 class="anchored" data-anchor-id="extract-the-feature">3. Extract the feature</h2>
<p>Now we can use <code>eider</code> to run the transformation pipeline. We specify the path to the data via <code>all_table_filenames</code> and the path the the specification via <code>all_feature_json_filenames</code>.</p>
<p>We then run the transformation which will produce the resultant dataframe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>ae_data_path <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">ae2 =</span> ae_data_filepath)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note the name ae2 is used in the spec example `source_file` above</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>tf <span class="ot">&lt;-</span> <span class="fu">transform</span>(ae_data_path, basic_ae_spec_filepath)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>tf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   id user_defined_name
1   0                 2
2   1                 1
3   2                 1
4   3                 0
5   4                 2
6   5                 1
7   6                 2
8   7                 5
9   8                 2
10  9                 0
11 10                 1
12 11                 1
13 12                 1
14 13                 1
15 14                 1
16 15                 0
17 16                 0
18 17                 2
19 18                 1
20 19                 2</code></pre>
</div>
</div>
<p>Above is the resultant dataframe. We can see that patient with id 2 had 1 instance where their <code>diagnosis_1</code> was 101, whereas patient with id 7 had 5 instances. It is also noted that patients with id 3, 9, 15, and 16 either do not fit the given filtering criteria or had no occurences in the source data. These patient’s resultant column value is the <code>absent_data_flag</code> from the specification.</p>
</section>
<section id="using-date-filtering" class="level2">
<h2 class="anchored" data-anchor-id="using-date-filtering">4. Using date filtering</h2>
<p>In the above example the returned dataframe spanned all the dates over which the input data csv spanned. However this can be refined in the specification.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>basic_ae_spec_w_date_filepath <span class="ot">&lt;-</span> <span class="fu">eider_example</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"spec_example_basic_ae_data_w_date.json"</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(<span class="fu">readLines</span>(basic_ae_spec_w_date_filepath))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "source_file": ["ae2"],
  "transformation_type": ["COUNT"],
  "grouping_columns": ["id"],
  "absent_data_flag": ["NA"],
  "output_feature_name": ["patients_w_diag_1_in_date_range"],
  "primary_filter": {
    "type": ["AND"],
    "subfilters": {
      "subfilter_1": {
        "column": ["attendance_category"],
        "type": ["IN"],
        "value": [1]
      },
      "subfilter_2": {
        "column": ["diagnosis_1"],
        "type": ["IN"],
        "value": [101]
      },
      "subfilter_3": {
        "column": ["time"],
        "type": ["date_gt"],
        "value": ["2015-12-31"]
      }
    }
  }
}</code></pre>
</div>
</div>
<p>An additonal subfilter has been added. Subfilter_3 is applied to the <code>time</code> column and filters based on dates that are greater than the 31st of December 2015. This means an event which happened on new-years-eve 2015 will not be included in the data, but events which occured on new-years-day 2016 would be. Also note the <code>absent_data_flag</code> has now been set to the string “NA”, and a more descriptive <code>output_feature_name</code> has been given in the specification</p>
<p>We can again run this transformation pipeline with the same A&amp;E data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>tf_w_date <span class="ot">&lt;-</span> <span class="fu">transform</span>(ae_data_path, basic_ae_spec_w_date_filepath)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>tf_w_date</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   id patients_w_diag_1_in_date_range
1   0                               2
2   1                              NA
3   2                              NA
4   3                              NA
5   4                               1
6   5                              NA
7   6                               1
8   7                               5
9   8                               1
10  9                              NA
11 10                               1
12 11                               1
13 12                               1
14 13                              NA
15 14                               1
16 15                              NA
17 16                              NA
18 17                              NA
19 18                               1
20 19                              NA</code></pre>
</div>
</div>
<p>We note that patient with id 2 now has no entries in the resultant table. This is expected as noted above patient 2 only had one instance where their <code>diagnosis_1</code> was 101, and from inspection of the source data, we can see that it was on the 28th July 2015.</p>
</section>
<section id="using-or-filter" class="level2">
<h2 class="anchored" data-anchor-id="using-or-filter">5. Using OR filter</h2>
<p>We can also expand the filters to return results if either <code>diagnosis_1</code> or <code>diagnosis_2</code> is 101. The specification file would look like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>basic_ae_spec_or_w_date_filepath <span class="ot">&lt;-</span> <span class="fu">eider_example</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"spec_example_basic_ae_data_or_w_date.json"</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(<span class="fu">readLines</span>(basic_ae_spec_or_w_date_filepath))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "source_file": ["ae2"],
  "transformation_type": ["COUNT"],
  "grouping_columns": ["id"],
  "absent_data_flag": ["NA"],
  "output_feature_name": ["using_or_filter"],
  "primary_filter": {
    "type": ["AND"],
    "subfilters": {
      "subfilter_1": {
        "column": ["attendance_category"],
        "type": ["IN"],
        "value": [1]
      },
      "subfilter_2": {
        "type": ["OR"],
        "subfilters": {
          "subfilter_21": {
            "column": ["diagnosis_1"],
            "type": ["IN"],
            "value": [101]
          },
          "subfilter_22": {
            "column": ["diagnosis_2"],
            "type": ["IN"],
            "value": [101]
          }
        }
      },
      "subfilter_3": {
        "column": ["time"],
        "type": ["date_gt"],
        "value": ["2015-12-31"]
      }
    }
  }
}</code></pre>
</div>
</div>
<p>Subfilter 2 has now been defined as an OR type, and it contains it’s own subfilters, 21 and 22. <code>subfilter_21</code> is a filter that <code>diagnosis_1</code> column is 101, and <code>subfilter_22</code> is a filter that <code>diagnosis_2</code> column is 101. So the transformation will count an instance if either <code>diagnosis_1</code> OR <code>diagnosis_2</code> are 101. Subject to the other filters of the <code>attendence_type</code> being 1, and the date being later than 31st December 2015.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>tf_or_w_date <span class="ot">&lt;-</span> <span class="fu">transform</span>(ae_data_path, basic_ae_spec_or_w_date_filepath)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>tf_or_w_date</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   id using_or_filter
1   0               4
2   1               1
3   2               2
4   3              NA
5   4               1
6   5               1
7   6               1
8   7               5
9   8               2
10  9              NA
11 10               2
12 11               1
13 12               2
14 13               3
15 14               2
16 15               1
17 16               1
18 17               1
19 18               2
20 19              NA</code></pre>
</div>
</div>
<p>Here we see patient 14 has 2 instances of either <code>diagnosis_1</code> or <code>diagnosis_2</code> being 101 when the <code>attendence_type</code> is 1, and for dates later than 31st December 2015.</p>
</section>
<section id="logging" class="level2">
<h2 class="anchored" data-anchor-id="logging">6.Logging</h2>
<p>Logging has also been introduced. By default the log is currently printed to the console. In order to see the log output in Quarto, we need to capture it in a temporary file.</p>
<p>The log is set up</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(logger)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>()</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">log_threshold</span>(TRACE)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">log_appender</span>(<span class="fu">appender_file</span>(tmp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And the first basic example is run again. Reminder this is the specification”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(<span class="fu">readLines</span>(basic_ae_spec_filepath))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "source_file": ["ae2"],
  "transformation_type": ["COUNT"],
  "grouping_columns": ["id"],
  "absent_data_flag": [0],
  "output_feature_name": ["user_defined_name"],
  "primary_filter": {
    "type": ["AND"],
    "subfilters": {
      "subfilter_1": {
        "column": ["attendance_category"],
        "type": ["IN"],
        "value": [1]
      },
      "subfilter_2": {
        "column": ["diagnosis_1"],
        "type": ["IN"],
        "value": [101]
      }
    }
  }
}</code></pre>
</div>
</div>
<p>And the transformation pipeline is run again - for completeness here is the result.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>tf <span class="ot">&lt;-</span> <span class="fu">transform</span>(ae_data_path, basic_ae_spec_filepath)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>tf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   id user_defined_name
1   0                 2
2   1                 1
3   2                 1
4   3                 0
5   4                 2
6   5                 1
7   6                 2
8   7                 5
9   8                 2
10  9                 0
11 10                 1
12 11                 1
13 12                 1
14 13                 1
15 14                 1
16 15                 0
17 16                 0
18 17                 2
19 18                 1
20 19                 2</code></pre>
</div>
</div>
<p>Check the log:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">readLines</span>(tmp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "TRACE [2024-03-07 02:06:49] context: featurise: /home/runner/work/_temp/Library/eider/extdata/spec_basic_ae_data.json"                                                                   
[2] "DEBUG [2024-03-07 02:06:49] Parsing nested filter"                                                                                                                                       
[3] "DEBUG [2024-03-07 02:06:49] Parsing single filter"                                                                                                                                       
[4] "DEBUG [2024-03-07 02:06:49] Parsing single filter"                                                                                                                                       
[5] "TRACE [2024-03-07 02:06:49] context: featurise: /home/runner/work/_temp/Library/eider/extdata/spec_basic_ae_data.json &gt; featurise_count"                                                 
[6] "TRACE [2024-03-07 02:06:49] context: featurise: /home/runner/work/_temp/Library/eider/extdata/spec_basic_ae_data.json &gt; featurise_count &gt; filter_and"                                    
[7] "TRACE [2024-03-07 02:06:49] context: featurise: /home/runner/work/_temp/Library/eider/extdata/spec_basic_ae_data.json &gt; featurise_count &gt; filter_and &gt; (1/2: subfilter_1) &gt; filter_basic"
[8] "TRACE [2024-03-07 02:06:49] context: featurise: /home/runner/work/_temp/Library/eider/extdata/spec_basic_ae_data.json &gt; featurise_count &gt; filter_and &gt; (2/2: subfilter_2) &gt; filter_basic"
[9] "TRACE [2024-03-07 02:06:50] context: join_feature_tables"                                                                                                                                </code></pre>
</div>
</div>
<p>Line 2 is when the primary filter is parsed. It has two subfilters so it is identified as a nested filter. The two subfilters (which themselves do not contain any subfilters) are then parsed, as reported on lines 3 and 4. Lines 5 - 9 give the context of what is being processed for debug purposes including the path to the corresponding specification files (which in this case are in the examples folder of this package).</p>
</section>
<section id="glossary" class="level2">
<h2 class="anchored" data-anchor-id="glossary">Glossary</h2>
<ul>
<li>The following comparison operators can be used for the type of filter. Note these are case insensitive.
<ul>
<li>“in” = <code>%in%</code></li>
<li>“lt” = <code>&lt;</code></li>
<li>“lt_eq” = <code>&lt;=</code></li>
<li>“gt” = <code>&gt;</code></li>
<li>“gt_eq” = <code>&gt;=</code></li>
<li>“date_in” = <code>%in%</code></li>
<li>“date_lt” = <code>&lt;</code></li>
<li>“date_lt_eq” = <code>&lt;=</code></li>
<li>“date_gt” = <code>&gt;</code></li>
<li>“date_gt_eq” = <code>&gt;=</code></li>
</ul></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>