---
title: "Examples: PIS data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Examples: PIS data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(eider)
library(magrittr)
```

This series of vignettes in the _Gallery_ section aim to demonstrate the functionality of `eider` through examples that are similar to real-life usage.
To do this, we have created a series of randomly generated datasets that are stored with the package.
You can access these datasets using the `eider_example()` function, which will return the path to where the dataset is stored in your installation of R.

```{r}
pis_data_filepath <- eider_example("random_pis_data.csv")

pis_data_filepath
```

## The data

In this specific vignette, we are using simulated [Prescribing Information System (PIS)](https://publichealthscotland.scot/services/national-data-catalogue/national-datasets/a-to-z-of-datasets/prescribing-information-system-pis/).
Our dataset does not contain every column specified in here, but serves as a useful example of how real-life data may be treated using `eider`.

```{r}
pis_data <- utils::read.csv(pis_data_filepath)
dplyr::glimpse(pis_data)
```

This simplified table has 4 columns:

* `id`, which is a numeric patient ID;

## 1. Prescribing data

```{r error = TRUE}
prescribing_data_filepath <- eider_example("random_pis_data.csv")
utils::read.csv(prescribing_data_filepath)
```
Here we have a random example prescribing data file. From the first few rows we can see that patient with id 19 had 3 items from under `bnf_section` 0106 prescribed on 15th December 2017, had 5 items from `bnf_section` 0103 prescribed on 11th August 2016, and had 1 item from `bnf_section` 0103 on 7th July 2015.

## 2. Specification file - Number of unique
```{r error = TRUE}
prescribing_spec_nunique_fp <- eider_example(
  "spec_example_basic_prescribing_nunique.json"
)
writeLines(readLines(prescribing_spec_nunique_fp))
```
This specification file is for defining the number of unique instances in the `bnf_section` column (called the "aggregation_column" in the specification) grouped by patient id.
So, if there were no more entries for patient 19 in the data file, then they would have 2 unique entries.
There is date filtering applied, in this case between 1st January 2015 and 1st January 2018 inclusive. 

## 3. Run transformation - Number of unique
```{r error = TRUE}
prescribing_data_path <- list(prescribing = prescribing_data_filepath)
run_pipeline(prescribing_data_path, prescribing_spec_nunique_fp)
```

The results of the transformation are shown above - here the patient with id 0 had 3 unique values of `bnf_section`, and the patient with id 19 ultimately ended up with 5 unique selections over the specified time period. 

## 4. Number of prescibed items
The following specification can be used to return the number of prescribed items, per patient over a specified date range.
```{r error = TRUE}
prescribing_spec_npresc_fp <- eider_example(
  "spec_example_basic_prescribing_nprescribed.json"
)
writeLines(readLines(prescribing_spec_npresc_fp))
```

With the corresponding transformation
```{r error = TRUE}
run_pipeline(prescribing_data_path, prescribing_spec_npresc_fp)
```
